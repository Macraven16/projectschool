generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Department {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  name          String
  role          Role           @default(STUDENT)
  departmentId  String?
  image         String?
  phoneNumber   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  auditLogs     AuditLog[]
  notifications Notification[]
  student       Student?
  department    Department?    @relation(fields: [departmentId], references: [id])
  schoolId      String?
  school        University?    @relation(fields: [schoolId], references: [id])
  deletionRequests DeletionRequest[]
}

model University {
  id            String         @id @default(cuid())
  name          String         @unique
  code          String         @unique @default("UNIV")
  logo          String?
  verified      Boolean        @default(false)
  address       String?
  contactEmail  String?
  contactPhone  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  courses       Course[]
  feeStructures FeeStructure[]
  students      Student[]
  users         User[]
}

model Student {
  id              String     @id @default(cuid())
  userId          String     @unique
  schoolId        String
  studentIdNumber String     @unique
  grade           String
  campus          String?
  department      String?
  course          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  budgets         Budget[]
  invoices        Invoice[]
  savings         Savings[]
  school          University @relation(fields: [schoolId], references: [id])
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet          Wallet?
  deletionRequests DeletionRequest[]
}

model Course {
  id          String     @id @default(cuid())
  schoolId    String
  name        String
  code        String
  credits     Int
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  school      University @relation(fields: [schoolId], references: [id])
}

model Wallet {
  id           String        @id @default(cuid())
  studentId    String        @unique
  balance      Float         @default(0.0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Transaction {
  id            String            @id @default(cuid())
  walletId      String
  amount        Float
  type          TransactionType
  status        TransactionStatus @default(PENDING)
  reference     String?
  method        PaymentMethod
  description   String?
  balanceBefore Float             @default(0.0)
  balanceAfter  Float             @default(0.0)
  date          DateTime          @default(now())
  wallet        Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
}

model FeeStructure {
  id        String     @id @default(cuid())
  schoolId  String
  name      String
  amount    Float
  dueDate   DateTime
  breakdown Json
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  school    University @relation(fields: [schoolId], references: [id])
  invoices  Invoice[]
}

model Invoice {
  id             String       @id @default(cuid())
  studentId      String
  feeStructureId String
  amountPaid     Float        @default(0.0)
  status         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id])
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  details   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Budget {
  id        String   @id @default(cuid())
  studentId String
  category  String
  amount    Float
  spent     Float    @default(0.0)
  period    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Savings {
  id            String    @id @default(cuid())
  studentId     String
  goalName      String
  targetAmount  Float
  currentAmount Float     @default(0.0)
  deadline      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

enum Role {
  STUDENT
  ADMIN
  STAFF
  MASTER_ADMIN
}

enum TransactionType {
  TUITION
  TOPUP
  MARKETPLACE
  OTHER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentMethod {
  MOMO
  CARD
  BANK
  WALLET
}

model DeletionRequest {
  id        String                @id @default(cuid())
  studentId String
  staffId   String
  reason    String
  status    DeletionRequestStatus @default(PENDING)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  student   Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  staff     User                  @relation(fields: [staffId], references: [id])
}

enum DeletionRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
